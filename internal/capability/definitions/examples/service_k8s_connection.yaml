# Service Kubernetes Connection Capability Definition
# This demonstrates a more complex service capability with authentication and connection management
name: service_k8s_connection_provider
type: service_k8s_connection_provider
version: "1.0.0"
description: "Dynamic service capability for managing Kubernetes cluster connections"

# Service lifecycle configuration
serviceConfig:
  # Service metadata
  serviceType: "DynamicK8sConnection"
  defaultLabel: "k8s-{{ .cluster_name }}"
  dependencies: []
  
  # Lifecycle tool mappings
  lifecycleTools:
    create:
      tool: "x_kubernetes_connect"
      arguments:
        clusterName: "{{ .cluster_name }}"
        context: "{{ .context | default .cluster_name }}"
        kubeconfig: "{{ .kubeconfig | default \"\" }}"
        authProvider: "{{ .auth_provider | default \"teleport\" }}"
      responseMapping:
        serviceId: "$.connectionId"
        status: "$.status"
        health: "$.connected"
        metadata:
          cluster_name: "$.clusterName"
          context: "$.context"
          auth_provider: "$.authProvider"
          server_version: "$.serverVersion"
          current_namespace: "$.currentNamespace"
    
    delete:
      tool: "x_kubernetes_disconnect"
      arguments:
        connectionId: "{{ .service_id }}"
      responseMapping:
        status: "$.status"
        
    healthCheck:
      tool: "x_kubernetes_connection_status"
      arguments:
        connectionId: "{{ .service_id }}"
      responseMapping:
        health: "$.connected"
        status: "$.status"
        error: "$.error"
        metadata:
          last_heartbeat: "$.lastHeartbeat"
          
    status:
      tool: "x_kubernetes_connection_info"
      arguments:
        connectionId: "{{ .service_id }}"
      responseMapping:
        metadata:
          nodes_count: "$.cluster.nodesCount"
          namespaces_count: "$.cluster.namespacesCount"
          pods_count: "$.cluster.podsCount"
          services_count: "$.cluster.servicesCount"
  
  # Health check configuration - more frequent for connection services
  healthCheck:
    enabled: true
    interval: "15s"
    failureThreshold: 2
    successThreshold: 1
  
  # Timeout configuration
  timeout:
    create: "120s"     # Longer timeout for authentication
    delete: "30s"
    healthCheck: "5s"
  
  # Parameter mapping for service creation
  createParameters:
    cluster_name:
      toolParameter: "clusterName"
      required: true
    context:
      toolParameter: "context"
      required: false
    kubeconfig:
      toolParameter: "kubeconfig"
      required: false
    auth_provider:
      toolParameter: "authProvider"
      default: "teleport"
      required: false

# External API operations
operations:
  create_connection:
    description: "Create a new Kubernetes cluster connection service"
    parameters:
      cluster_name:
        type: string
        required: true
        description: "Name of the Kubernetes cluster"
      context:
        type: string
        required: false
        description: "Kubernetes context name (defaults to cluster_name)"
      kubeconfig:
        type: string
        required: false
        description: "Path to kubeconfig file (optional)"
      auth_provider:
        type: string
        required: false
        description: "Authentication provider (teleport, aws, gcp, etc.)"
    requires:
      - x_service_orchestrator_create_service
    workflow:
      name: create_k8s_connection_service
      description: "Create a dynamic Kubernetes connection service"
      agentModifiable: false
      inputSchema:
        type: object
        properties:
          cluster_name:
            type: string
          context:
            type: string
          kubeconfig:
            type: string
          auth_provider:
            type: string
        required:
          - cluster_name
      steps:
        - id: create_connection_service
          tool: x_service_orchestrator_create_service
          args:
            capability_name: "service_k8s_connection_provider"
            label: "k8s-{{ .cluster_name }}"
            parameters:
              cluster_name: "{{ .cluster_name }}"
              context: "{{ .context }}"
              kubeconfig: "{{ .kubeconfig }}"
              auth_provider: "{{ .auth_provider }}"
          store: connection_result

  switch_context:
    description: "Switch the active context for a connection service"
    parameters:
      service_label:
        type: string
        required: true
        description: "Label of the connection service"
      namespace:
        type: string
        required: false
        description: "New default namespace"
    requires:
      - x_kubernetes_switch_context
    workflow:
      name: switch_k8s_context
      description: "Switch context for existing connection"
      steps:
        - id: switch_context
          tool: x_kubernetes_switch_context
          args:
            serviceLabel: "{{ .service_label }}"
            namespace: "{{ .namespace }}"
          store: switch_result

  list_connections:
    description: "List all Kubernetes connection service instances"
    requires:
      - x_service_orchestrator_list_services
    workflow:
      name: list_k8s_connections
      description: "List Kubernetes connection services"
      steps:
        - id: list_connections
          tool: x_service_orchestrator_list_services
          args:
            capability_type: "service_k8s_connection_provider"
          store: connections_list

# Metadata
metadata:
  provider: "kubernetes"
  category: "connection"
  icon: "☸️"
  version: "1.0.0"
  # Additional metadata for this capability type
  supports:
    - "multi-cluster"
    - "authentication"
    - "context-switching"
  dependencies:
    - "teleport" # or other auth providers
  documentation: "https://docs.example.com/k8s-connections" 